# docker-compose.qdrant.yml
#
# Docker Compose configuration for Axiom Memory Backend with Qdrant
#
# Usage:
#   docker-compose -f docker-compose.qdrant.yml up
#   docker-compose -f docker-compose.qdrant.yml up -d  # Background
#   docker-compose -f docker-compose.qdrant.yml down
#
# Author: Axiom AI Assistant
# Created: 2025-01-28

version: '3.8'

services:
  # Qdrant vector database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: axiom-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC API (optional)
    volumes:
      - qdrant_data:/qdrant/storage
      - ./qdrant_config:/qdrant/config
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - axiom-network

  # Axiom Memory Backend with Qdrant integration
  axiom-memory:
    build:
      context: .
      dockerfile: services/memory/Dockerfile
    container_name: axiom-memory-backend
    restart: unless-stopped
    ports:
      - "8002:5000"  # Memory API (host 8002 -> container 5000)
    volumes:
      - ./.axiom-data:/app/data
      - memory_logs:/app/data/logs
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - USE_QDRANT_BACKEND=true
      - AXIOM_USE_SENTENCE_TRANSFORMERS=true
      - LOG_LEVEL=INFO
      - MEMORY_POD_URL=http://localhost:8002
      - PYTHONPATH=/app
      # Composite scoring flags are controlled via .env at repo root (see .env.example). Do not enable here by default.
      # AXIOM_COMPOSITE_SCORING=1
      # AXIOM_SCORING_PROFILE=default
      # AXIOM_TOP_N=8
      # AXIOM_MMR_LAMBDA=0.4
    depends_on:
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/app/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    networks:
      - axiom-network

  # Optional: Qdrant Web UI (for debugging and monitoring)
  qdrant-web-ui:
    image: qdrant/qdrant-web-ui:latest
    container_name: axiom-qdrant-ui
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - QDRANT_API_URL=http://qdrant:6333
    depends_on:
      qdrant:
        condition: service_healthy
    networks:
      - axiom-network
    profiles:
      - web-ui  # Optional service, start with: docker-compose --profile web-ui up

volumes:
  qdrant_data:
    driver: local
    name: axiom_qdrant_data
  memory_logs:
    driver: local
    name: axiom_memory_logs

networks:
  axiom-network:
    driver: bridge
    name: axiom-network